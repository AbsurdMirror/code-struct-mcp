# 代码文档管理工具 - 技术架构文档

## 1. 架构设计

```mermaid
graph TD
    A[AI模型客户端] --> B[MCP协议接口]
    C[人类用户] --> D[RESTful API接口]
    E[Web前端界面] --> D
    
    B --> F[模块管理核心]
    D --> F
    F --> G[数据存储层]
    
    subgraph "接口层"
        B[MCP协议接口<br/>MOD004]
        D[RESTful API接口<br/>MOD005]
    end
    
    subgraph "业务逻辑层"
        F[模块管理核心<br/>MOD002]
    end
    
    subgraph "数据层"
        G[数据存储层<br/>MOD001]
        H[(YAML文件存储)]
        G --> H
    end
```

## 2. 技术描述

- 前端：React@18 + TypeScript + Tailwind CSS + Vite
- 后端：Node.js@18 + TypeScript + Express@4
- 数据存储：YAML文件系统
- 协议支持：MCP协议 + RESTful API
- 开发工具：TypeScript@5 + ESLint + Prettier

## 3. 路由定义

### 3.1 MCP协议路由

| 工具名称 | 功能描述 |
|---------|----------|
| add_module | 添加新的代码模块，支持class、function、variable等类型 |
| get_module_by_name | 根据层次化名称获取指定模块信息 |
| smart_search | 智能搜索模块，支持关键词、类型、文件路径等条件 |
| get_type_structure | 获取指定类型的结构信息和层次关系 |

### 3.2 RESTful API路由

| 路由 | 方法 | 功能描述 |
|------|------|----------|
| /api/modules | GET | 获取根模块列表 |
| /api/modules | POST | 添加新模块 |
| /api/modules/search | GET | 搜索模块 |
| /api/modules/{hierarchical_name} | GET | 获取指定模块 |
| /api/modules/{hierarchical_name} | PUT | 更新模块信息 |
| /api/modules/{hierarchical_name} | DELETE | 删除模块 |

## 4. API定义

### 4.1 核心数据类型

**模块基础类型**
```typescript
interface Module {
  name: string;                    // 模块名称
  hierarchical_name: string;       // 层次化名称
  type: 'class' | 'function' | 'variable' | 'file' | 'functionGroup';
  parent_module?: string;          // 父模块层次化名称
  file_path: string;              // 文件路径
  access_modifier: 'public' | 'private' | 'protected';
  description?: string;           // 描述信息
  created_at: string;             // 创建时间
  updated_at: string;             // 更新时间
}
```

**类模块类型**
```typescript
interface ClassModule extends Module {
  type: 'class';
  inheritance?: string[];         // 继承关系
  interfaces?: string[];          // 实现的接口
  methods?: string[];            // 方法列表
  properties?: string[];         // 属性列表
}
```

**函数模块类型**
```typescript
interface FunctionModule extends Module {
  type: 'function';
  parameters: Parameter[];        // 参数列表
  return_type?: string;          // 返回值类型
  is_async: boolean;             // 是否异步函数
}
```

**变量模块类型**
```typescript
interface VariableModule extends Module {
  type: 'variable';
  data_type: string;             // 数据类型
  initial_value?: string;        // 初始值
  is_constant: boolean;          // 是否常量
}
```

### 4.2 MCP协议接口

**添加模块**
```
TOOL: add_module
```

请求参数：
| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| name | string | true | 模块名称 |
| type | string | true | 模块类型 |
| parent_module | string | false | 父模块层次化名称 |
| file_path | string | true | 文件路径 |
| access_modifier | string | true | 访问修饰符 |
| description | string | false | 描述信息 |

响应格式：
```json
{
  "success": true,
  "data": {
    "hierarchical_name": "parent.child.module",
    "message": "模块添加成功"
  }
}
```

### 4.3 RESTful API接口

**获取模块列表**
```
GET /api/modules
```

查询参数：
| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| type | string | false | 模块类型过滤 |
| parent | string | false | 父模块过滤 |
| limit | number | false | 返回数量限制 |

响应格式：
```json
{
  "success": true,
  "data": {
    "modules": [...],
    "total": 100,
    "page": 1
  }
}
```

## 5. 服务器架构图

```mermaid
graph TD
    A[HTTP请求/MCP请求] --> B[路由层]
    B --> C[控制器层]
    C --> D[服务层]
    D --> E[数据访问层]
    E --> F[(YAML存储)]
    
    subgraph "Express服务器"
        B[路由层<br/>Express Router]
        C[控制器层<br/>Request Handler]
    end
    
    subgraph "业务逻辑层"
        D[服务层<br/>Business Logic]
        G[验证层<br/>Data Validation]
        H[缓存层<br/>Memory Cache]
        D --> G
        D --> H
    end
    
    subgraph "数据层"
        E[数据访问层<br/>Data Access]
        I[备份管理<br/>Backup Manager]
        E --> I
    end
```

## 6. 数据模型

### 6.1 数据模型定义

```mermaid
erDiagram
    MODULE ||--o{ MODULE : "parent-child"
    MODULE ||--o{ PARAMETER : "has"
    MODULE {
        string name PK
        string hierarchical_name UK
        string type
        string parent_module FK
        string file_path
        string access_modifier
        string description
        datetime created_at
        datetime updated_at
    }
    
    PARAMETER {
        string name PK
        string module_name FK
        string data_type
        string default_value
        boolean is_required
        string description
    }
    
    CLASS_MODULE {
        string hierarchical_name PK
        string inheritance
        string interfaces
        string methods
        string properties
    }
    
    FUNCTION_MODULE {
        string hierarchical_name PK
        string return_type
        boolean is_async
    }
    
    VARIABLE_MODULE {
        string hierarchical_name PK
        string data_type
        string initial_value
        boolean is_constant
    }
    
    MODULE ||--o| CLASS_MODULE : "extends"
    MODULE ||--o| FUNCTION_MODULE : "extends"
    MODULE ||--o| VARIABLE_MODULE : "extends"
```

### 6.2 数据定义语言

**YAML存储结构**
```yaml
# modules.yaml
modules:
  - name: "MyClass"
    hierarchical_name: "project.core.MyClass"
    type: "class"
    parent_module: "project.core"
    file_path: "/src/core/MyClass.ts"
    access_modifier: "public"
    description: "核心业务类"
    created_at: "2024-01-01T00:00:00Z"
    updated_at: "2024-01-01T00:00:00Z"
    # 类特有属性
    inheritance: ["BaseClass"]
    interfaces: ["IMyInterface"]
    methods: ["project.core.MyClass.method1"]
    properties: ["project.core.MyClass.prop1"]
    
  - name: "method1"
    hierarchical_name: "project.core.MyClass.method1"
    type: "function"
    parent_module: "project.core.MyClass"
    file_path: "/src/core/MyClass.ts"
    access_modifier: "public"
    description: "核心方法"
    created_at: "2024-01-01T00:00:00Z"
    updated_at: "2024-01-01T00:00:00Z"
    # 函数特有属性
    parameters:
      - name: "param1"
        data_type: "string"
        default_value: null
        is_required: true
        description: "参数1"
    return_type: "boolean"
    is_async: false

# 配置文件 config.yaml
config:
  storage:
    root_path: "./data"
    backup_enabled: true
    backup_interval: 3600
    max_backups: 10
  validation:
    max_nesting_level: 5
    max_name_length: 100
    allowed_types: ["class", "function", "variable", "file", "functionGroup"]
  cache:
    enabled: true
    ttl: 300
    max_size: 1000
```

**初始化数据**
```yaml
# 示例数据
modules:
  - name: "root"
    hierarchical_name: "root"
    type: "file"
    parent_module: null
    file_path: "/"
    access_modifier: "public"
    description: "根模块"
    created_at: "2024-01-01T00:00:00Z"
    updated_at: "2024-01-01T00:00:00Z"
```