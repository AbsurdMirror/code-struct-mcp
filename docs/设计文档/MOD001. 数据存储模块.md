# MOD001. 数据存储模块

## 基本信息

### 模块ID
MOD001

### 模块名
数据存储模块

### 模块描述
负责代码文档数据的持久化存储和管理，采用YAML格式存储，提供数据的读写、验证和备份功能。支持灵活的存储路径配置和自动初始化。

## 依赖模块
无

## 接口列表
- load_modules() -> dict - 加载所有模块数据
- save_modules(modules: dict) -> bool - 保存模块数据
- validate_data(data: dict) -> tuple[bool, list] - 验证数据完整性
- initialize_storage(custom_path: str = None) -> tuple[bool, str] - 初始化存储环境

## 变量列表

### VAR001. storage_root_path
- **变量ID**: VAR001
- **变量名**: storage_root_path
- **变量类型**: string
- **变量描述**: 存储文档数据的根目录路径

### VAR002. config_file
- **变量ID**: VAR002
- **变量名**: config_file
- **变量类型**: string
- **变量描述**: 配置文件路径，固定为"config.yaml"

### VAR003. data_file
- **变量ID**: VAR003
- **变量名**: data_file
- **变量类型**: string
- **变量描述**: 主数据文件路径，固定为"modules.yaml"

## 函数列表

### FUNC001. initialize_storage
- **函数ID**: FUNC001
- **函数名**: initialize_storage
- **参数列表**:
  - custom_path: string (可选) - 自定义存储路径，默认为None
- **返回值列表**:
  - success: bool - 初始化是否成功
  - message: string - 操作结果描述
- **函数描述**:
  1. CHECK custom_path参数有值：
     - 如果有值：storage_root_path = custom_path
     - 如果无值：storage_root_path = 当前工作目录 + ".code-doc-mcp"
  2. CHECK storage_root_path目录是否存在：
     - 如果存在：跳过创建
     - 如果不存在：创建storage_root_path目录
  3. CHECK config_file文件是否存在：
     - 如果存在：跳过创建
     - 如果不存在：在storage_root_path下创建config_file文件
  4. CHECK data_file文件是否存在：
     - 如果存在：跳过创建
     - 如果不存在：在storage_root_path下创建空的data_file文件
  5. 返回初始化结果(success, message)

### FUNC002. load_modules
- **函数ID**: FUNC002
- **函数名**: load_modules
- **参数列表**:
  - 无
- **返回值列表**:
  - modules: dict - 模块数据字典
- **函数描述**:
  1. 构建完整文件路径：data_file = storage_root_path + "modules.yaml"
  2. CHECK data_file文件是否存在：
     - 如果存在：读取文件内容
     - 如果不存在：返回空字典{}
  3. 解析YAML格式数据为Python字典
  4. 调用validate_data函数验证数据完整性
  5. 返回解析后的modules数据字典

### FUNC003. save_modules
- **函数ID**: FUNC003
- **函数名**: save_modules
- **参数列表**:
  - modules: dict - 要保存的模块数据
- **返回值列表**:
  - success: bool - 保存是否成功
- **函数描述**:
  1. 调用validate_data函数验证modules数据格式
  2. 构建完整文件路径：data_file = storage_root_path + "modules.yaml"
  3. CHECK data_file文件是否存在：
     - 如果存在：创建备份文件（添加时间戳后缀）
     - 如果不存在：跳过备份步骤
  4. 将modules数据序列化为YAML格式字符串
  5. 写入YAML字符串到data_file文件
  6. 返回保存结果(success)

### FUNC004. validate_data
- **函数ID**: FUNC004
- **函数名**: validate_data
- **参数列表**:
  - data: dict - 待验证的数据
- **返回值列表**:
  - is_valid: bool - 数据是否有效
  - errors: list - 错误信息列表
- **函数描述**:
  1. CHECK data是否为字典类型：
     - 如果不是：添加错误"数据必须是字典类型"
  2. CHECK data是否包含"modules"键：
     - 如果不包含：添加错误"缺少必需的modules字段"
  3. CHECK data["modules"]是否为字典类型：
     - 如果不是：添加错误"modules必须是字典类型"
  4. 遍历每个模块验证必需字段：
     - CHECK每个模块是否包含"name"字段
     - CHECK每个模块是否包含"type"字段
     - CHECK type字段值是否在[class, function, variable, file, functionGroup]范围内
  5. 收集所有验证错误到errors列表
  6. 返回验证结果(is_valid, errors)