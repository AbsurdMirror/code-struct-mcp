# MOD004. AI模型MCP接口

## 基本信息

### 模块ID
MOD004

### 模块名
AI模型MCP接口

### 模块描述
实现Model Context Protocol（MCP）协议规范，为AI模型提供标准化的工具调用接口。仅提供Tools接口，支持AI模型安全地访问代码文档系统，实现模块查询、分析和管理功能。遵循MCP Client-Server架构，作为MCP Server端提供代码文档服务。支持层次化命名系统，解决同名模块冲突问题。

## 依赖模块
- MOD001. 数据存储模块
- MOD002. 模块管理模块
- MOD003. 查询引擎模块

## 数据结构定义

### MCPRequest接口定义
| 字段名 | 类型 | 必需 | 描述 |
|---|---|---|---|
| jsonrpc | string | 是 | JSON-RPC版本，固定为"2.0" |
| id | string \| number | 是 | 请求唯一标识符 |
| method | string | 是 | 调用方法（tools/call） |
| params | MCPParams | 是 | 方法参数 |

### MCPResponse接口定义
| 字段名 | 类型 | 必需 | 描述 |
|---|---|---|---|
| jsonrpc | string | 是 | JSON-RPC版本，固定为"2.0" |
| id | string \| number | 是 | 对应请求的标识符 |
| result | MCPResult | 否 | 成功结果数据 |
| error | MCPError | 否 | 错误信息 |

### ToolCall接口定义（MCP工具定义）
| 字段名 | 类型 | 必需 | 描述 |
|---|---|---|---|
| name | string | 是 | 工具名称 |
| description | string | 是 | 工具描述 |
| inputSchema | object | 是 | JSON Schema定义的工具参数结构 |

### ValidationRule接口定义（参数验证规则）
| 字段名 | 类型 | 必需 | 描述 |
|---|---|---|---|
| field | string | 是 | 需要验证的字段名 |
| type | string | 是 | 期望的数据类型 |
| required | boolean | 否 | 是否为必需字段 |
| enum | string[] | 否 | 允许的枚举值列表 |
| pattern | string | 否 | 正则表达式验证模式 |

### Module接口定义（与MOD002完全一致）
| 字段名 | 类型 | 必需 | 描述 |
|---|---|---|---|
| name | string | 是 | 模块名称（非唯一标识符） |
| hierarchical_name | string | 是 | 层次化唯一标识符（点号分隔路径） |
| type | 'class' \| 'function' \| 'variable' \| 'file' \| 'functionGroup' | 是 | 模块类型 |
| description | string | 是 | 模块描述 |
| parent | string | 否 | 父模块的hierarchical_name |
| file | string | 否 | 所属文件路径 |

### SearchResult接口定义
| 字段名 | 类型 | 必需 | 描述 |
|---|---|---|---|
| module | Module | 是 | 模块信息 |
| score | number | 是 | 匹配分数 |

### TypeStructure接口定义
| 字段名 | 类型 | 必需 | 描述 |
|---|---|---|---|
| type_name | 'class' \| 'function' \| 'variable' \| 'file' \| 'functionGroup' | 是 | 类型名称 |
| structure | object | 是 | 该类型的数据结构格式定义 |
| description | string | 是 | 类型描述 |
| fields | object[] | 是 | 该类型包含的字段定义列表 |

## 接口列表
- parse_tool_parameters(tool_name: string, raw_params: any) -> ParsedParams - 解析MCP工具参数
- handle_mcp_tools(name: string, args: any) -> MCPResponse - 处理MCP工具调用
- list_available_tools() -> ToolCall[] - 列出可用工具

## 变量列表

### VAR001. mcp_tools_registry
- **变量ID**: VAR001
- **变量名**: mcp_tools_registry
- **变量类型**: Record<string, ToolCall>
- **变量描述**: MCP工具注册表，存储4个核心工具定义

### VAR002. parameter_validation_rules
- **变量ID**: VAR002
- **变量名**: parameter_validation_rules
- **变量类型**: Record<string, ValidationRule[]>
- **变量描述**: 参数验证规则表，定义各工具参数的验证逻辑

### VAR003. type_structures
- **变量ID**: VAR003
- **变量名**: type_structures
- **变量类型**: Record<string, TypeStructure>
- **变量描述**: 类型结构定义表，存储各模块类型的数据结构规范

## 函数列表

### FUNC001. parse_tool_parameters
- **函数ID**: FUNC001
- **函数名**: parse_tool_parameters
- **参数列表**:
  - tool_name: string - 工具名称
  - raw_params: any - 原始参数对象
- **返回值列表**:
  - parsed_params: ParsedParams - 标准化参数对象
- **函数描述**:
  1. 从parameter_validation_rules获取验证规则
  2. 根据tool_name选择对应解析逻辑：
     - add_module: 执行完整参数验证和hierarchical_name生成
     - get_module_by_name: 验证hierarchical_name字段
     - smart_search: 验证可选搜索字段
     - get_type_structure: 验证type_name字段
  3. 执行参数类型检查和转换
  4. 返回标准化参数对象或错误信息

### FUNC002. handle_mcp_tools
- **函数ID**: FUNC002
- **函数名**: handle_mcp_tools
- **参数列表**:
  - name: string - 工具名称
  - args: any - 工具参数
- **返回值列表**:
  - response: MCPResponse - MCP协议响应
- **函数描述**:
  1. 调用parse_tool_parameters验证参数
  2. 根据name选择对应处理：
     - add_module: 自动生成hierarchical_name，调用MOD002.add_module
     - get_module_by_name: 调用MOD002.find_modules，使用hierarchical_name精确匹配
     - smart_search: 调用MOD002.find_modules，参数为SearchCriteria对象
     - get_type_structure: 从type_structures获取指定类型的TypeStructure对象
  3. 构建MCPResponse对象
  4. 返回成功响应

### FUNC003. list_available_tools
- **函数ID**: FUNC003
- **函数名**: list_available_tools
- **参数列表**:
  - 无
- **返回值列表**:
  - tools: ToolCall[] - 可用工具列表
- **函数描述**:
  1. 从mcp_tools_registry获取4个核心工具定义
  2. 格式化为标准ToolCall数组
  3. 返回工具列表

### FUNC004. generate_hierarchical_name
- **函数ID**: FUNC004
- **函数名**: generate_hierarchical_name
- **参数列表**:
  - parent: string - 父模块的hierarchical_name
  - name: string - 模块名称
- **返回值列表**:
  - hierarchical_name: string - 生成的层次化名称
- **函数描述**:
  1. 验证name格式：只支持字母、数字、下划线，不能以数字开头
  2. 如果parent为空：返回name作为hierarchical_name
  3. 否则：返回`${parent}.${name}`
  4. 检查层次深度是否超过5层
  5. 返回生成的hierarchical_name